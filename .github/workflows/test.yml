name: Test Static Server Action

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Check test directory
        run: |
          echo "ğŸ“ Checking test directory contents:"
          ls -la test/ || echo "âŒ test/ directory not found"
          echo ""
          echo "ğŸ“„ Checking for index.html:"
          if [[ -f test/index.html ]]; then
            echo "âœ… test/index.html exists"
            echo "Content preview:"
            head -5 test/index.html
          else
            echo "âŒ test/index.html not found, creating one..."
            mkdir -p test
            echo "<h1>Hello World!</h1><p>Test server is working</p>" > test/index.html
            echo "âœ… Created test/index.html"
          fi
        
      - name: Start static server
        id: server
        uses: johnz86/static-serve-action@v1
        with:
          directory: ./test
          port: 3000
          
      - name: Wait for server startup
        run: |
          echo "â³ Waiting for server to be ready..."
          sleep 3
          
      - name: Test server health
        run: |
          echo "ğŸ” Testing server health at ${{ steps.server.outputs.url }}"
          curl -f ${{ steps.server.outputs.url }}
          echo "âœ… Server health check passed!"
          
      - name: Test specific endpoints
        run: |
          echo "ğŸ” Testing specific endpoints..."
          
          # Test root should serve index.html
          echo "Testing root path..."
          curl -f ${{ steps.server.outputs.url }}/ >/dev/null
          
          # Test direct index.html access
          echo "Testing direct index.html access..."
          curl -f ${{ steps.server.outputs.url }}/index.html >/dev/null
          
          echo "âœ… All endpoint tests passed!"
          
      - name: Test concurrent requests
        run: |
          echo "ğŸ”€ Testing concurrent requests..."
          for i in {1..3}; do
            curl -f ${{ steps.server.outputs.url }} >/dev/null &
          done
          wait
          echo "âœ… Concurrent requests handled successfully!"
          
      - name: Cleanup server
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up server..."
          if [[ -n "${{ steps.server.outputs.pid }}" ]]; then
            kill ${{ steps.server.outputs.pid }} || true
            echo "âœ… Server stopped"
          else
            echo "âš ï¸ No server PID found"
          fi
